module.exports=function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=12)}([function(e,t){e.exports=require("triframe/core")},function(e,t){e.exports=require("@babel/runtime/regenerator")},function(e,t){e.exports=require("@babel/runtime/helpers/slicedToArray")},function(e,t){e.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(e,t){e.exports=require("@babel/runtime/helpers/defineProperty")},function(e,t){e.exports=require("@babel/runtime/helpers/taggedTemplateLiteral")},function(e,t){e.exports=require("@babel/runtime/helpers/typeof")},function(e,t){e.exports=require("@babel/runtime/helpers/toConsumableArray")},function(e,t){e.exports=require("@babel/runtime/helpers/classCallCheck")},function(e,t){e.exports=require("@babel/runtime/helpers/toArray")},function(e,t){e.exports=require("@babel/runtime/helpers/construct")},function(e,t){e.exports=require("pg")},function(e,t,n){"use strict";n.r(t),n.d(t,"connect",(function(){return K})),n.d(t,"sql",(function(){return X})),n.d(t,"Model",(function(){return yt})),n.d(t,"string",(function(){return ve})),n.d(t,"text",(function(){return Oe})),n.d(t,"numeric",(function(){return je})),n.d(t,"float",(function(){return ge})),n.d(t,"integer",(function(){return Ee})),n.d(t,"boolean",(function(){return ke})),n.d(t,"timestamp",(function(){return we})),n.d(t,"timestamptz",(function(){return Ne})),n.d(t,"date",(function(){return Ae})),n.d(t,"time",(function(){return Te})),n.d(t,"point",(function(){return Se})),n.d(t,"line",(function(){return _e})),n.d(t,"lseg",(function(){return De})),n.d(t,"path",(function(){return Le})),n.d(t,"polygon",(function(){return Ce})),n.d(t,"circle",(function(){return xe})),n.d(t,"list",(function(){return Pe})),n.d(t,"json",(function(){return Re})),n.d(t,"serial",(function(){return Ue})),n.d(t,"pk",(function(){return qe})),n.d(t,"virtual",(function(){return Fe})),n.d(t,"hasMany",(function(){return Me})),n.d(t,"belongsTo",(function(){return Je})),n.d(t,"hasOne",(function(){return Ie})),n.d(t,"_public",(function(){return Ve})),n.d(t,"_protected",(function(){return ze})),n.d(t,"_private",(function(){return Ke})),n.d(t,"shared",(function(){return Ye})),n.d(t,"stream",(function(){return Qe})),n.d(t,"session",(function(){return Be})),n.d(t,"validate",(function(){return We})),n.d(t,"include",(function(){return He}));var r=n(6),o=n.n(r),a=n(2),i=n.n(a),c=n(4),u=n.n(c),s=n(1),l=n.n(s),d=n(3),f=n.n(d),p=n(0),h=n(7),y=n.n(h);function b(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?b(Object(n),!0).forEach((function(t){u()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):b(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var v,O,j=function(){var e=f()(l.a.mark((function e(){var t,n,r;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(p.map)(Object(p.group)(Object(p.filter)(p.metadata,(function(e,t){return"persisted"===t.type})),(function(e,t){return Object(p.toTableName)(t.className)})),(function(e,t){return Object(p.index)(t,(function(e,t){return Object(p.toUnderscored)(t.key)}))})),e.t0=S,e.next=4,z.query(T());case 4:if(e.t1=e.sent,n=(0,e.t0)(e.t1),!(r=R(n,t))){e.next=11;break}return console.log("Patching:",r),e.next=11,z.query(r);case 11:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),g=function(e,t){var n=t.datatype,r=t.typeModifier,o=t.defaultValue,a=t.constraints,i='"'.concat(e,'" ').concat(n);return r&&(i="".concat(i,"(").concat(r,")")),void 0!==o&&(i="".concat(i," DEFAULT ").concat(E(o))),a&&(i="".concat(i," ").concat(k(a))),i},E=function(e){if(null===e)return"NULL";if("number"==typeof e||"boolean"==typeof e)return e;if("string"==typeof e)return"'".concat(e,"'");if("object"==o()(e)&&e.__proto__==Object.prototype)return"'".concat(JSON.stringify(e),"'::json");if(e instanceof Date)return"NOW()";if(Array.isArray(e))return"'".concat(JSON.stringify(e),"'");throw Error("Variable type cannot be coalesced for sql query: ".concat(e))},k=function(e){var t=e.unique,n=e.notNull,r=e.primaryKey,o=e.references,a="";if(t&&(a="".concat(a," UNIQUE ")),n&&(a="".concat(a," NOT NULL ")),r&&(a="".concat(a," PRIMARY KEY ")),o){var i=o.table,c=o.onDelete;a="".concat(a," REFERENCES ").concat(i,"(id) ON DELETE ").concat(C.fromJS.toSQL[c]||"SET NULL")}return a},w=function(e,t){var n=t.table,r=t.onDelete;return"ADD CONSTRAINT ".concat(e,"_fkey FOREIGN KEY(").concat(e,") REFERENCES ").concat(n,"(id) ON DELETE ").concat(C.fromJS.toSQL[r]||"SET NULL")},N=function(e){return"DROP CONSTRAINT ".concat(e,"_fkey")},A=function(e){if(!e)return e;var t=e.split("::");return i()(t,1)[0].replace(/'/g,"")},T=function(){return"\n    SELECT \n        tab.relname as table_name,\n        attr.attname as name,\n        ty.typname as type,\n        attr.atttypmod as type_modifier,\n        con.contype as constraint_type,\n        ref_table.relname as reference_table,\n        con.confdeltype as on_delete,\n        con.confupdtype as on_update,\n        attr.attnotnull as not_null,\n        pg_get_expr(de.adbin, de.adrelid) as default_value\n    FROM\n        pg_class as tab\n        JOIN pg_catalog.pg_namespace as n \n            ON n.oid = tab.relnamespace\n        LEFT JOIN pg_attribute as attr\n            ON tab.oid = attr.attrelid\n        LEFT JOIN pg_type as ty\n            ON attr.atttypid = ty.oid\n        LEFT JOIN pg_attrdef as de\n            ON  \n                tab.oid = de.adrelid\n            AND\n                attr.attnum = de.adnum\n        LEFT JOIN pg_constraint as con \n            ON \n                attr.attrelid = con.conrelid\n            AND\n                attr.attnum = ANY(con.conkey)\n        LEFT JOIN pg_class as ref_table ON con.confrelid = ref_table.oid\n    WHERE \n        tab.relkind = 'r'\n            AND\n        n.nspname = 'public'\n            AND\n        attr.attnum >= 0\n            AND\n        ty.typname IS NOT NULL\n"},S=function(e){return Object(p.map)(Object(p.group)(e.rows,"table_name"),(function(e,t){return Object(p.map)(Object(p.group)(t,"name"),(function(e,t){return{tableName:t[0].table_name,key:t[0].name,datatype:t[0].type,typeModifier:t[0].type_modifier,defaultValue:A(t[0].default_value),constraints:m({notNull:t[0].not_null},Object(p.map)(Object(p.index)(t,_),D))}}))}))},_=function(e,t){var n=t.constraint_type;return P.fromEnum.toJS[n]?P.fromEnum.toJS[n]:"details"},D=function(e,t){var n=t.reference_table,r=t.on_delete;t.on_update;return"references"!=e||{onDelete:C.fromEnum.toJS[r],table:n}},L=[{enum:"r",sql:"RESTRICT",js:"restrict"},{enum:"a",sql:"NO ACTION",js:"noAction"},{enum:"d",sql:"SET DEFAULT",js:"setDefault"},{enum:"c",sql:"CASCADE",js:"cascade"},{enum:"n",sql:"SET NULL",js:"setNull"}],C={fromEnum:{toJS:Object(p.index)(L,"enum","js"),toSQL:Object(p.index)(L,"enum","sql")},fromJS:{toEnum:Object(p.index)(L,"js","enum"),toSQL:Object(p.index)(L,"js","sql")},fromSQL:{toJS:Object(p.index)(L,"sql","js"),toEnum:Object(p.index)(L,"sql","enum")}},x=[{enum:"p",js:"primaryKey"},{enum:"f",js:"references"},{enum:"u",js:"unique"}],P={fromJS:{toEnum:Object(p.index)(x,"js","enum")},fromEnum:{toJS:Object(p.index)(x,"enum","js")}},R=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Object,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Object,n=Object(p.unique)([].concat(y()(Object.keys(e)),y()(Object.keys(t)))),r=n.map((function(n){return U(e,t,n)})).sort((function(e){return!e.startsWith("CREATE TABLE")})).filter((function(e){return e})).join(";\n");return r},U=function(e,t,n){var r=J(e,t),o=r.added,a=r.removed;if(o(n))return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Array;return'CREATE TABLE "'.concat(e,'" (').concat(Object.values(Object(p.map)(t,g)).join(", "),");")}(n,t[n]);if(a(n))return'DROP TABLE "'.concat(n,'"');var i=q(e[n],t[n]);return i?'ALTER TABLE "'.concat(n,'" ').concat(i):void 0},q=function(e,t){return Object(p.unique)([].concat(y()(Object.keys(e)),y()(Object.keys(t)))).map((function(n){return F(e,t,n)})).filter((function(e){return e.length})).join(", ")},F=function(e,t,n){var r,o,a=J(e,t),i=a.added,c=a.removed;return i(n)?(r=n,o=t[n],"ADD COLUMN ".concat(g(r,o))):c(n)?function(e){return'DROP COLUMN "'.concat(e,'"')}(n):"SERIAL"===t[n].datatype?[]:M(n,e[n],t[n])},M=function(e,t,n){var r,o,a=J(t,n),i=(a.added,a.removed),c=a.different,u=new Array;return c("datatype")&&u.push((r=e,o=n.datatype,'ALTER COLUMN "'.concat(r,'" TYPE ').concat(o))),i("defaultValue")?u.push(function(e){return'ALTER COLUMN "'.concat(e,'" DROP DEFAULT')}(e)):c("defaultValue")&&u.push(function(e,t){return'ALTER COLUMN "'.concat(e,'" SET DEFAULT ').concat(E(t))}(e,n.defaultValue)),(u=[].concat(y()(u),[I(e,t.constraints,n.constraints)])).filter((function(e){return e.length})).join(", ")},I=function(e,t,n){var r,o=J(t,n),a=o.added,i=o.removed,c=o.different,u=[];return a("primaryKey")&&u.push("ADD CONSTRAINT ".concat(r=e,"_pk PRIMARY KEY(").concat(r,")")),i("primaryKey")&&u.push(function(e){return"DROP CONSTRAINT ".concat(e,"_pk")}(e)),a("notNull")&&u.push(function(e){return'ALTER COLUMN "'.concat(e,'" SET NOT NULL')}(e)),i("notNull")&&u.push(function(e){return'ALTER COLUMN "'.concat(e,'" DROP NOT NULL')}(e)),a("unique")&&u.push(function(e){return"ADD CONSTRAINT ".concat(e,"_unique UNIQUE(").concat(e,")")}(e)),i("unique")&&u.push(function(e){return"DROP CONSTRAINT ".concat(e,"_unique")}(e)),a("references")&&u.push(w(e,n.references)),i("references")&&u.push(N(e)),c("references")&&u.push("".concat(N(e),";\n ").concat(w(e,n.references))),u},J=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=function(n){return e[n]&&void 0===t[n]},r=function(n){return void 0===e[n]&&t[n]},o=function(n){return t[n]instanceof Date?"now()"!=e[n]:"boolean"==typeof t[n]?"true"===e[n]!=t[n]:e[n]!=t[n]};return{added:r,removed:n,different:o}},V=n(11).Client,z=null,K=function(){var e=f()(l.a.mark((function e(t){return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return z=new V(t),e.next=3,z.connect();case 3:return e.next=5,j();case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Y=function(e){return{isLiteral:!0,value:e}},B=function(e){return e&&e.isLiteral},W=function(e){var t=Object.keys(e).map(p.toUnderscored);return{join:function(e){return Y(t.join(e))}}},H=function(e){var t=Object.values(e).map($);return{join:function(e){return Y(t.join(e))}}},Q=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:" = ",n=Object.keys(e).map((function(n){return"".concat(Object(p.toUnderscored)(n)).concat(t).concat($(e[n]))}));return{join:function(e){return Y(n.join(e))}}},G=[],$=function(e){return G.push(e),"$".concat(G.length)},X=function(){var e=f()(l.a.mark((function e(t){var n,r,o,a,i,c,u,s,d=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(n=d.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=d[o];return O||(O=Object(p.index)(p.metadata,(function(e){return e.className}),(function(e){return e.Class}))),a=t.reduce((function(e,t,n){return 0===n?"".concat(t):B(r[n-1])?"".concat(e).concat(r[n-1].value).concat(t):"".concat(e).concat($(r[n-1])).concat(t)}),""),i=Z(a),console.log(i,G),c=z.query(i,G),G=[],e.next=9,c;case 9:return u=e.sent,s=Object(p.deepMap)(u.rows,(function(e){if(e&&e.__class__){var t=O[e.__class__],n=new t;return new t(Object(p.index)(e,(function(e){return Object(p.toCamelCase)(e)}),(function(e,t){var r=Object(p.getMetadata)(n,e).sqlDecode;return r?r(t):t})))}return Array.isArray(e)?e.filter((function(e){return null!==e.id})):e})),e.abrupt("return",s);case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();function Z(e){v||(v=Object(p.map)(Object(p.group)(Object(p.filter)(p.metadata,(function(e,t){return null!=t.type})),"className"),(function(e,t){return Object(p.index)(t,"key")})));for(var t={},n=t,r="",o=!1,a=e,i=Symbol(),c=0;c<e.length;c++){var s=e[c];!1!==o?ae(s)||("{"!=s?"}"!=s?","!=s?r+=s:(r.length&&(n[r]=!0),r=""):(r.length&&(n[r]=!0),n===t?(a=a.slice(0,o)+te(t,a.slice(c+1)),o=!1,n=t={}):n=n[i],r=""):(n[r]=u()({},i,n),n=n[r],r="")):"{"==s&&(o=c)}return a}var ee=Symbol();function te(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=Object.keys(e);if(n.length>1)throw Error("Cannot select ".concat(n.join(", ")," simultaneously"));var r=i()(n,1),o=r[0],a=Object(p.toClassName)(o),c=e[o],u=ne(a,c),s=re(a,c),l=t.split("ORDER BY"),d=i()(l,2),f=d[0],h=d[1],y=void 0===h?"":h;return y&&(y="ORDER BY ".concat(y)),"".concat(u," FROM ").concat(o," ").concat(s," ").concat(f,' GROUP BY "').concat(o,'".id ').concat(y)}function ne(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.label,o=void 0!==r&&r,a=n.alias,i=void 0!==a&&a,c=n.nested,u=void 0!==c&&c,s=[],l=v[e],d=i||Object(p.toTableName)(e);return s.push(o?"'id', \"".concat(d,'".id'):'"'.concat(d,'".id'),o?"'__class__', '".concat(e,"'"):"'".concat(e,"' as __class__")),Object(p.each)(t,(function(n,r){var a="boolean"==typeof r;switch(l[n].type){case"persisted":if(!a)throw Error("Cannot select subfields of property ".concat(e,"#").concat(n));s.push(o?"'".concat(Object(p.toUnderscored)(n),"', \"").concat(d,'".').concat(Object(p.toUnderscored)(n)):'"'.concat(d,'".').concat(Object(p.toUnderscored)(n)));break;case"relationship":if(a)throw Error("Must select subfields for relation ".concat(e,"#").concat(n));var c,f=l[n],h=f.options,y=f.joinType,b=Object(p.toClassName)(h.a||h.an||h.of||n);switch(y){case"belongsTo":case"hasOne":c="(array_agg(json_build_object(".concat(ne(b,r,{label:!0,alias:n,nested:!0}),")))[1]");break;case"hasMany":c="array_agg(json_build_object(".concat(ne(b,r,{label:!0,alias:n,nested:!0}),"))")}u?(Object.defineProperty(t,ee,{enumerable:!1,value:!0}),s.push(o?"'".concat(Object(p.toUnderscored)(n),"', \"").concat(d,'".').concat(Object(p.toUnderscored)(n)):Object(p.toUnderscored)(n))):s.push(o?"'".concat(Object(p.toUnderscored)(n),"', ").concat(c):"".concat(c," as ").concat(Object(p.toUnderscored)(n)));break;case"virtual":if(!a)throw Error("Cannot select subfields of property ".concat(e,"#").concat(n));var m=l[n],O=m.definition,j=m.defaultValue,g={};O(oe(e,g,{nested:u,alias:i}));var E=Object(p.find)(g,(function(t){return"relationship"===v[e][t].type}));if(u&&E)Object.defineProperty(t,ee,{enumerable:!1,value:!0}),s.push(o?"'".concat(Object(p.toUnderscored)(n),"', \"").concat(d,'".').concat(Object(p.toUnderscored)(n)):Object(p.toUnderscored)(n));else{var k=O(oe(e,t,{nested:u,alias:i}));void 0!==j&&(k="COALESCE(".concat(k,", ").concat(ce(j),")")),s.push(o?"'".concat(Object(p.toUnderscored)(n),"', ").concat(k):"".concat(k," as ").concat(Object(p.toUnderscored)(n)))}}})),s.join(", ")}function re(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=(n.label,n.alias),o=void 0!==r&&r,a=(n.nested,[]);return Object(p.each)(t,(function(t,n){var r,c=t,s=v[e],l=s[t],d=l.type,f=l.options,h=e;if("relationship"===d){if("boolean"==typeof n)throw Error("Must select subfields for relation ".concat(e,"#").concat(t));if(f.through){var y={};for(f.through(oe(e,y));;){var b=Object.keys(y);if(ie(y[t=i()(b,1)[0]]))break;var m=s[t],O=m.options;m.joinType;a.push(re(h,u()({},t,{}))),y=y[t],h=Object(p.toClassName)(O.a||O.an||O.of||t),s=v[h],o=t}}var j=s[t];f=j.options,r=j.joinType;var g=o||Object(p.toTableName)(h),E=Object(p.toClassName)(f.a||f.an||f.of||t),k=f.as||h;switch(r){case"belongsTo":n[Object(p.toForeignKeyName)(t)]=!0,a.push(n[ee]?"LEFT JOIN (\n                                        SELECT ".concat(te(u()({},Object(p.toTableName)(E),n)),"\n                                    ) as ").concat(c," ON ").concat(g,".").concat(Object(p.toForeignKeyName)(t)," = ").concat(Object(p.toTableName)(c),".id"):"LEFT JOIN ".concat(Object(p.toTableName)(E)," as ").concat(c," ON ").concat(g,".").concat(Object(p.toForeignKeyName)(t)," = ").concat(Object(p.toTableName)(c),".id"));break;case"hasOne":case"hasMany":n[Object(p.toForeignKeyName)(k)]=!0,a.push(n[ee]?"LEFT JOIN (\n                                    SELECT ".concat(te(u()({},Object(p.toTableName)(E),n)),"\n                                ) as ").concat(c," ON ").concat(c,".").concat(Object(p.toForeignKeyName)(k)," = ").concat(g,".id"):"LEFT JOIN ".concat(Object(p.toTableName)(E)," as ").concat(c," ON ").concat(c,".").concat(Object(p.toForeignKeyName)(k)," = ").concat(g,".id"))}}})),a.join(", ")}function oe(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=n.nested,o=n.alias,a=o||Object(p.toTableName)(e),i={toString:function(){return a}},c=v[e];return Object(p.each)(c,(function(e,n){Object.defineProperty(i,e,{get:function(){switch(c[e].type){case"persisted":return t[e]=t[e]||!0,'"'.concat(a,'".').concat(Object(p.toUnderscored)(e));case"relationship":var n=c[e].options,o=Object(p.toClassName)(n.a||n.an||n.of||e);return t[e]=t[e]||{},oe(o,t[e],{nested:!0,alias:e});case"virtual":var u=c[e],s=u.definition,l=u.defaultValue;return r?(s(i),'"'.concat(a,'".').concat(Object(p.toUnderscored)(e))):void 0!==l?"COALESCE(".concat(s(i),", ").concat(l,")"):s(i)}}})})),i}function ae(e){return/\s/.test(e)}function ie(e){return 0===Object.keys(e).length}var ce=function(e){if(null===e)return"NULL";if("number"==typeof e||"boolean"==typeof e)return e;if("string"==typeof e)return"'".concat(e,"'");if("object"==o()(e)&&e.__proto__==Object.prototype)return"'".concat(JSON.stringify(e),"'::json");if(e instanceof Date)return"NOW()";throw Error("Variable type cannot be coalesced for sql query: ".concat(e))},ue=n(5),se=n.n(ue),le=n(8),de=n.n(le),fe=n(9),pe=n.n(fe),he=n(10),ye=n.n(he);function be(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function me(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?be(Object(n),!0).forEach((function(t){u()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):be(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var ve=Ge((function(e){return{datatype:"varchar",constraints:e.decoratorArgs[1]||{}}})),Oe=Ge((function(e){return{datatype:"text",constraints:e.decoratorArgs[1]||{}}})),je=Ge((function(e){return{datatype:"numeric",constraints:e.decoratorArgs[1]||{}}})),ge=Ge((function(e){return{datatype:"float8",constraints:e.decoratorArgs[1]||{}}})),Ee=Ge((function(e){return{datatype:"int4",constraints:e.decoratorArgs[1]||{}}})),ke=Ge((function(e){return{datatype:"bool",constraints:e.decoratorArgs[1]||{}}})),we=Ge((function(e){return{datatype:"timestamp",constraints:e.decoratorArgs[1]||{}}})),Ne=Ge((function(e){return{datatype:"timestamptz",constraints:e.decoratorArgs[1]||{}}})),Ae=Ge((function(e){return{datatype:"date",constraints:e.decoratorArgs[1]||{}}})),Te=Ge((function(e){return{datatype:"time",constraints:e.decoratorArgs[1]||{}}})),Se=Ge((function(e){return{datatype:"point",constraints:e.decoratorArgs[1]||{}}})),_e=Ge((function(e){return{datatype:"line",constraints:e.decoratorArgs[1]||{}}})),De=Ge((function(e){return{datatype:"lseg",constraints:e.decoratorArgs[1]||{}}})),Le=Ge((function(e){return{datatype:"path",constraints:e.decoratorArgs[1]||{}}})),Ce=Ge((function(e){return{datatype:"polygon",constraints:e.decoratorArgs[1]||{}}})),xe=Ge((function(e){return{datatype:"circle",constraints:e.decoratorArgs[1]||{}}})),Pe=Ge((function(e){return{datatype:"json",constraints:e.decoratorArgs[1]||{},sqlEncode:function(e){return JSON.stringify(e)},sqlDecode:function(e){try{return JSON.parse(e)}catch(t){return e}}}})),Re=Ge((function(e){return{datatype:"json",constraints:e.decoratorArgs[1]||{},sqlEncode:function(e){return JSON.stringify(e)},sqlDecode:function(e){try{return JSON.parse(e)}catch(t){return e}}}})),Ue=Ge((function(e){return{datatype:"SERIAL",constraints:e.decoratorArgs[0]||{}}})),qe=Ue({primaryKey:!0}),Fe=$e((function(e){var t=i()(e.decoratorArgs,1)[0],n=e.target,r=e.key,o=e.fieldValue;return e.isMethod||Object.defineProperty(n,r,Xe(r)),{isShared:!0,type:"virtual",definition:t,defaultValue:o}})),Me=$e((function(e){var t=i()(e.decoratorArgs,1)[0],n=void 0===t?{}:t,r=e.target,o=e.key,a=e.fieldValue;return Object.defineProperty(r,o,Xe(o)),{isShared:!0,type:"relationship",joinType:"hasMany",options:n,defaultValue:a}})),Ie=$e((function(e){var t=i()(e.decoratorArgs,1)[0],n=void 0===t?{}:t,r=e.target,o=e.key,a=e.fieldValue;return Object.defineProperty(r,o,Xe(o)),{isShared:!0,type:"relationship",joinType:"hasOne",options:n,defaultValue:a}})),Je=$e((function(e){var t=i()(e.decoratorArgs,1)[0],n=void 0===t?{}:t,r=e.target,o=e.key,a=e.fieldValue,c=Object(p.toCamelCase)(Object(p.toForeignKeyName)(o));return Object(p.saveMetadata)(r,c,{type:"persisted",datatype:"int4",isShared:!0}),Object.defineProperty(r,o,Xe(o)),Object.defineProperty(r,c,Xe(c)),{isShared:!0,type:"relationship",joinType:"belongsTo",options:n,defaultValue:a}})),Ve=$e((function(e){e.decoratorArgs,e.fieldValue;return{accessLevel:"public"}})),ze=$e((function(e){var t=e.decoratorArgs;e.fieldValue;return{accessLevel:"protected",authCheck:t[0]}})),Ke=$e((function(e){e.decoratorArgs,e.fieldValue;return{accessLevel:"private"}})),Ye=$e((function(e){e.decoratorArgs,e.fieldValue;return{isShared:!0}})),Be=$e((function(e){e.decoratorArgs,e.fieldValue;return{usesSession:!0}})),We=$e((function(e){var t=e.decoratorArgs,n=e.target,r=e.key;e.fieldValue;return t.forEach((function(e){return n.validation.addHandler(r,e)})),{validators:t}})),He=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return function(e){Object(p.index)(t,"name");Ze((function(e){var n="function"==typeof e?e:e.constructor,r="function"==typeof e?e.prototype:e;Object(p.each)(t,(function(e,t){Object(p.each)(Object.getOwnPropertyDescriptors(t),(function(e,r){if("name"!=e&&"prototype"!=e&&"length"!=e){var o=Object(p.getMetadata)(t,e);et(o)||Object(p.saveMetadata)(n,e,o),Object.defineProperty(n,e,r)}})),Object(p.each)(Object.getOwnPropertyDescriptors(t.prototype),(function(e,n){if("constructor"!==e){var o=Object(p.getMetadata)({__proto__:{constructor:t}},e);et(o)||Object(p.saveMetadata)(r,e,o),Object.defineProperty(r,e,n)}}))}))}))(e)}},Qe=function(e){var t;(t=function(e){var t=function(t){for(var n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return e.call.apply(e,[this].concat(r))};return function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return ye()(p.Pipe,[[this,t]].concat(n))}},function(e){var n;switch(e.kind){case"field":n="function"==typeof e.initializer?e.initializer:function(){return null},e.initializer=function(){return function(){for(var e=arguments.length,r=new Array(e),o=0;o<e;o++)r[o]=arguments[o];t((function(){return n.apply(void 0,r)}))}};break;case"method":n=e.descriptor.value,e.descriptor.value=t(n)}return e})(e)};function Ge(e){var t=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return delete(t=Ze((function(t,r,o){Object(p.saveMetadata)(t,r,me({isShared:!0,type:"persisted",defaultValue:o},e({decoratorArgs:n,target:t,key:r,fieldValue:o})))}))(t)).initializer,delete t.descriptor.value,delete t.descriptor.writable,me({},t,{kind:"method",placement:"prototype",descriptor:me({},t.descriptor,{},Xe(t.key))})};return function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return n[0]&&n[0].descriptor&&n[0].kind?t(n[0]):function(e){return t(e,n)}}}function $e(e){var t=function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];Ze((function(t,r,o,a){return Object(p.saveMetadata)(t,r,me({},e({decoratorArgs:n,target:t,key:r,fieldValue:o,isMethod:a})))}))(t)};return function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return n[0]&&n[0].descriptor&&n[0].kind?t(n[0]):function(e){return t(e,n)}}}function Xe(e){return{enumerable:!0,get:new Function("\n            return this['[[attributes]]'].".concat(e,"\n        ")),set:new Function("value","\n            this['[[attributes]]'].".concat(e," = value\n            let patch = {\n                op: 'replace',\n                path: '/").concat(e,"',\n                value\n            }\n            this['[[patches]]'].push(patch)\n            this.emit('Δ.change', [ patch ])\n        "))}}function Ze(e){return function(t){var n=t.finisher,r=t.initializer;return t.finisher=function(o){var a;switch("function"==typeof n&&n(o),t.placement){case"class":e(o);break;case"static":a="field"===t.kind&&"function"==typeof r?r():void 0,e(o,t.key,a);break;default:a="field"===t.kind&&"function"==typeof r?r():void 0,e(o.prototype,t.key,a,"method"===t.kind)}},t}}var et=function(e){return 0===Object.keys(e).length};function tt(){var e=se()(["\n            DELETE FROM "," WHERE true\n        "]);return tt=function(){return e},e}function nt(){var e=se()(["\n            SELECT {\n                "," {\n                    ","\n                }\n            }\n            WHERE (",") \n            ORDER BY ",".id ASC\n        "]);return nt=function(){return e},e}function rt(){var e=se()(["\n            SELECT {\n                "," {\n                    ","\n                }\n            }\n            WHERE (",") \n            ORDER BY ",".id ASC\n        "]);return rt=function(){return e},e}function ot(){var e=se()(["\n            SELECT {\n                "," {\n                    ","\n                }\n            }\n            ORDER BY ",".id ASC\n        "]);return ot=function(){return e},e}function at(){var e=se()(["\n            DELETE FROM "," WHERE id = ","\n        "]);return at=function(){return e},e}function it(){var e=se()(["\n            UPDATE "," \n            SET ","\n            WHERE id = ","\n        "]);return it=function(){return e},e}function ct(){var e=se()(["\n            SELECT {\n                "," {\n                    ","\n                }\n            }\n            WHERE ",".id = ","\n        "]);return ct=function(){return e},e}function ut(){var e=se()(["\n            INSERT INTO "," (",") \n            VALUES (",")\n            RETURNING id\n        "]);return ut=function(){return e},e}function st(e){var t,n=ht(e.key);"method"===e.kind?t={value:e.value,writable:!0,configurable:!0,enumerable:!1}:"get"===e.kind?t={get:e.value,configurable:!0,enumerable:!1}:"set"===e.kind?t={set:e.value,configurable:!0,enumerable:!1}:"field"===e.kind&&(t={configurable:!0,writable:!0,enumerable:!0});var r={kind:"field"===e.kind?"field":"method",key:n,placement:e.static?"static":"field"===e.kind?"own":"prototype",descriptor:t};return e.decorators&&(r.decorators=e.decorators),"field"===e.kind&&(r.initializer=e.value),r}function lt(e,t){void 0!==e.descriptor.get?t.descriptor.get=e.descriptor.get:t.descriptor.set=e.descriptor.set}function dt(e){return e.decorators&&e.decorators.length}function ft(e){return void 0!==e&&!(void 0===e.value&&void 0===e.writable)}function pt(e,t){var n=e[t];if(void 0!==n&&"function"!=typeof n)throw new TypeError("Expected '"+t+"' to be a function");return n}function ht(e){var t=function(e,t){if("object"!==o()(e)||null===e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!==o()(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===o()(t)?t:String(t)}var yt=function(e,t,n,r){var o=function(){(function(){return e});var e={elementsDefinitionOrder:[["method"],["field"]],initializeInstanceElements:function(e,t){["method","field"].forEach((function(n){t.forEach((function(t){t.kind===n&&"own"===t.placement&&this.defineClassElement(e,t)}),this)}),this)},initializeClassElements:function(e,t){var n=e.prototype;["method","field"].forEach((function(r){t.forEach((function(t){var o=t.placement;if(t.kind===r&&("static"===o||"prototype"===o)){var a="static"===o?e:n;this.defineClassElement(a,t)}}),this)}),this)},defineClassElement:function(e,t){var n=t.descriptor;if("field"===t.kind){var r=t.initializer;n={enumerable:n.enumerable,writable:n.writable,configurable:n.configurable,value:void 0===r?void 0:r.call(e)}}Object.defineProperty(e,t.key,n)},decorateClass:function(e,t){var n=[],r=[],o={static:[],prototype:[],own:[]};if(e.forEach((function(e){this.addElementPlacement(e,o)}),this),e.forEach((function(e){if(!dt(e))return n.push(e);var t=this.decorateElement(e,o);n.push(t.element),n.push.apply(n,t.extras),r.push.apply(r,t.finishers)}),this),!t)return{elements:n,finishers:r};var a=this.decorateConstructor(n,t);return r.push.apply(r,a.finishers),a.finishers=r,a},addElementPlacement:function(e,t,n){var r=t[e.placement];if(!n&&-1!==r.indexOf(e.key))throw new TypeError("Duplicated element ("+e.key+")");r.push(e.key)},decorateElement:function(e,t){for(var n=[],r=[],o=e.decorators,a=o.length-1;a>=0;a--){var i=t[e.placement];i.splice(i.indexOf(e.key),1);var c=this.fromElementDescriptor(e),u=this.toElementFinisherExtras((0,o[a])(c)||c);e=u.element,this.addElementPlacement(e,t),u.finisher&&r.push(u.finisher);var s=u.extras;if(s){for(var l=0;l<s.length;l++)this.addElementPlacement(s[l],t);n.push.apply(n,s)}}return{element:e,finishers:r,extras:n}},decorateConstructor:function(e,t){for(var n=[],r=t.length-1;r>=0;r--){var o=this.fromClassDescriptor(e),a=this.toClassDescriptor((0,t[r])(o)||o);if(void 0!==a.finisher&&n.push(a.finisher),void 0!==a.elements){e=a.elements;for(var i=0;i<e.length-1;i++)for(var c=i+1;c<e.length;c++)if(e[i].key===e[c].key&&e[i].placement===e[c].placement)throw new TypeError("Duplicated element ("+e[i].key+")")}}return{elements:e,finishers:n}},fromElementDescriptor:function(e){var t={kind:e.kind,key:e.key,placement:e.placement,descriptor:e.descriptor};return Object.defineProperty(t,Symbol.toStringTag,{value:"Descriptor",configurable:!0}),"field"===e.kind&&(t.initializer=e.initializer),t},toElementDescriptors:function(e){if(void 0!==e)return pe()(e).map((function(e){var t=this.toElementDescriptor(e);return this.disallowProperty(e,"finisher","An element descriptor"),this.disallowProperty(e,"extras","An element descriptor"),t}),this)},toElementDescriptor:function(e){var t=String(e.kind);if("method"!==t&&"field"!==t)throw new TypeError('An element descriptor\'s .kind property must be either "method" or "field", but a decorator created an element descriptor with .kind "'+t+'"');var n=ht(e.key),r=String(e.placement);if("static"!==r&&"prototype"!==r&&"own"!==r)throw new TypeError('An element descriptor\'s .placement property must be one of "static", "prototype" or "own", but a decorator created an element descriptor with .placement "'+r+'"');var o=e.descriptor;this.disallowProperty(e,"elements","An element descriptor");var a={kind:t,key:n,placement:r,descriptor:Object.assign({},o)};return"field"!==t?this.disallowProperty(e,"initializer","A method descriptor"):(this.disallowProperty(o,"get","The property descriptor of a field descriptor"),this.disallowProperty(o,"set","The property descriptor of a field descriptor"),this.disallowProperty(o,"value","The property descriptor of a field descriptor"),a.initializer=e.initializer),a},toElementFinisherExtras:function(e){return{element:this.toElementDescriptor(e),finisher:pt(e,"finisher"),extras:this.toElementDescriptors(e.extras)}},fromClassDescriptor:function(e){var t={kind:"class",elements:e.map(this.fromElementDescriptor,this)};return Object.defineProperty(t,Symbol.toStringTag,{value:"Descriptor",configurable:!0}),t},toClassDescriptor:function(e){var t=String(e.kind);if("class"!==t)throw new TypeError('A class descriptor\'s .kind property must be "class", but a decorator created a class descriptor with .kind "'+t+'"');this.disallowProperty(e,"key","A class descriptor"),this.disallowProperty(e,"placement","A class descriptor"),this.disallowProperty(e,"descriptor","A class descriptor"),this.disallowProperty(e,"initializer","A class descriptor"),this.disallowProperty(e,"extras","A class descriptor");var n=pt(e,"finisher");return{elements:this.toElementDescriptors(e.elements),finisher:n}},runClassFinishers:function(e,t){for(var n=0;n<t.length;n++){var r=(0,t[n])(e);if(void 0!==r){if("function"!=typeof r)throw new TypeError("Finishers must return a constructor.");e=r}}return e},disallowProperty:function(e,t,n){if(void 0!==e[t])throw new TypeError(n+" can't have a ."+t+" property.")}};return e}();if(r)for(var a=0;a<r.length;a++)o=r[a](o);var i=t((function(e){o.initializeInstanceElements(e,c.elements)}),n),c=o.decorateClass(function(e){for(var t=[],n=function(e){return"method"===e.kind&&e.key===a.key&&e.placement===a.placement},r=0;r<e.length;r++){var o,a=e[r];if("method"===a.kind&&(o=t.find(n)))if(ft(a.descriptor)||ft(o.descriptor)){if(dt(a)||dt(o))throw new ReferenceError("Duplicated methods ("+a.key+") can't be decorated.");o.descriptor=a.descriptor}else{if(dt(a)){if(dt(o))throw new ReferenceError("Decorators can't be placed on different accessors with for the same property ("+a.key+").");o.decorators=a.decorators}lt(a,o)}else t.push(a)}return t}(i.d.map(st)),e);return o.initializeClassElements(i.F,c.elements),o.runClassFinishers(i.F,c.finishers)}(null,(function(e){var t,n,r;return{F:function t(){de()(this,t),e(this)},d:[{kind:"field",decorators:[qe],key:"id",value:void 0},{kind:"field",static:!0,key:"events",value:function(){return new p.EventEmitter}},{kind:"method",static:!0,key:"create",value:(r=f()(l.a.mark((function e(t){var n,r,o,a,c,u,s=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=s.length>1&&void 0!==s[1]?s[1]:null,r=this.relation,o=this.fieldsFrom(t),e.next=5,X(ut(),r,W(o).join(", "),H(o).join(", "));case 5:return a=e.sent,c=i()(a,1),u=c[0].id,this.events.emit("create"),e.next=11,this.read(u,n);case 11:return e.abrupt("return",e.sent);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{kind:"method",decorators:[Qe],static:!0,key:"read",value:l.a.mark((function e(t){var n,r,o,a,c,u=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null==(n=u.length>1&&void 0!==u[1]?u[1]:null)&&(n=this.defaultSelectedColumns),e.next=4,this.events.nowAndOn(["delete.".concat(t)]);case 4:return r=this.relation,e.next=7,X(ct(),r,Y(n),r,t);case 7:return o=e.sent,a=i()(o,1),c=a[0],e.abrupt("return",c);case 11:case"end":return e.stop()}}),e,this)}))},{kind:"method",key:"update",value:(n=f()(l.a.mark((function e(){var t,n,r,o,a=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.length>0&&void 0!==a[0]?a[0]:{},Object.assign(this,t),n=this.constructor.relation,r=this.constructor.fieldsFrom(this),bt(this,"commiting",this),e.next=7,X(it(),n,Q(r).join(", "),this.id);case 7:return o=e.sent,bt(this,"commited",this),e.abrupt("return",o);case 10:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{kind:"method",key:"delete",value:function(){var e=this.constructor.relation,t=X(at(),e,this.id);return this.constructor.events.emit("delete.".concat(this.id)),t}},{kind:"method",decorators:[Qe],static:!0,key:"list",value:l.a.mark((function e(){var t,n,r=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return null==(t=r.length>0&&void 0!==r[0]?r[0]:null)&&(t=this.defaultSelectedColumns),e.next=4,this.events.nowAndOn("*");case 4:return n=this.relation,e.abrupt("return",X(ot(),n,Y(t),n));case 6:case"end":return e.stop()}}),e,this)}))},{kind:"method",decorators:[Qe],static:!0,key:"where",value:l.a.mark((function e(t){var n,r,o=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>1&&void 0!==o[1]?o[1]:null,r=this.relation,null==n&&(n=this.defaultSelectedColumns),e.next=5,this.events.nowAndOn("*");case 5:return e.abrupt("return",X(rt(),r,Y(n),Q(t).join(" AND "),r));case 6:case"end":return e.stop()}}),e,this)}))},{kind:"method",decorators:[Qe],static:!0,key:"search",value:l.a.mark((function e(t){var n,r,o=arguments;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>1&&void 0!==o[1]?o[1]:null,r=this.relation,null==n&&(n=this.defaultSelectedColumns),e.next=5,this.events.nowAndOn("*");case 5:return e.abrupt("return",X(nt(),r,Y(n),Q(t,"LIKE").join(" OR "),r));case 6:case"end":return e.stop()}}),e,this)}))},{kind:"method",static:!0,key:"truncate",value:(t=f()(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.relation,e.abrupt("return",X(tt(),t));case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{kind:"get",static:!0,key:"defaultSelectedColumns",value:function(){return Object.keys(this.persistedFields).join(",\n")}},{kind:"get",static:!0,key:"relation",value:function(){return Y(Object(p.toTableName)(this.name))}},{kind:"get",static:!0,key:"persistedFields",value:function(){var e=this;return Object(p.index)(Object(p.filter)(p.metadata,(function(t,n){return n.className===e.name&&"persisted"===n.type})),"key")}},{kind:"method",static:!0,key:"fieldsFrom",value:function(e){var t=new this,n=this.persistedFields,r={};return Object(p.each)(n,(function(n){if(void 0!==e[n]){var o=Object(p.getMetadata)(t,n).sqlEncode;r[n]=o?o(e[n]):e[n]}})),r}}]}})),bt=function(e,t,n){e.emit("Δ.".concat(t),n);var r="on".concat(toCapitalized(t));"function"==typeof e[r]&&e[r](n)}}]);